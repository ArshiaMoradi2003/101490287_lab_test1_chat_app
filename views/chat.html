<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<div class="chat-container">
    <!-- Header -->
    <div class="chat-header">
        <h4>Chat app</h4>
        <button id="logoutBtn" class="btn btn-danger">Leave Room</button>
    </div>

    <!-- Room Selection -->
    <div class="room-selection">
        <label>Room:</label>
        <select id="roomSelect" class="form-select">
            <option value="">Select a room</option>
            <option value="devops">DevOps</option>
            <option value="cloud">Cloud Computing</option>
            <option value="covid19">Covid19</option>
            <option value="sports">Sports</option>
            <option value="nodeJS">NodeJS</option>
        </select>
        <button id="joinRoom" class="btn btn-primary">Join Chat Room</button>
    </div>

    <!-- Current Room Info -->
    <div class="current-room-info" id="roomInfo">
        <div><strong>Room name:</strong> <span id="currentRoomName">-</span></div>
        <div class="members-list"><strong>Members:</strong> <span id="membersList">-</span></div>
    </div>

    <!-- Chat Messages -->
    <div id="chatBox">
        <div class="empty-state">
            <p>ðŸ‘‹ Welcome! Select a room to start chatting.</p>
        </div>
    </div>

    <!-- Typing Indicator -->
    <div id="typing"></div>

    <!-- Message Input -->
    <div class="message-input-area">
        <div class="d-flex gap-2 mb-2" id="privateMessageToggle" style="display: none !important;">
            <label class="form-check-label" style="font-size: 14px; color: #666;">
                <input type="checkbox" id="privateCheckbox" class="form-check-input">
                Send as Private Message to:
            </label>
            <input type="text" id="recipientInput" class="form-control form-control-sm" placeholder="Enter username" style="max-width: 200px;" disabled>
        </div>
        <div class="input-group">
            <input id="messageInput" type="text" class="form-control" placeholder="Type your message here..." disabled>
            <button id="sendBtn" class="btn btn-success" disabled>Send</button>
        </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const user = JSON.parse(localStorage.getItem("user"));
    
    // Redirect if not logged in
    if (!user) {
        window.location.href = "/views/login.html";
    }

    // Register user with socket server
    socket.emit("userJoin", user.username);

    const chatBox = document.getElementById("chatBox");
    const roomSelect = document.getElementById("roomSelect");
    const joinRoomBtn = document.getElementById("joinRoom");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const typingText = document.getElementById("typing");
    const roomInfo = document.getElementById("roomInfo");
    const currentRoomName = document.getElementById("currentRoomName");
    const membersList = document.getElementById("membersList");
    const privateCheckbox = document.getElementById("privateCheckbox");
    const recipientInput = document.getElementById("recipientInput");
    const privateMessageToggle = document.getElementById("privateMessageToggle");
    
    let currentRoom = "";
    let typingTimeout;
    let onlineUsers = new Set();

    // Toggle private message input
    privateCheckbox.addEventListener("change", () => {
        recipientInput.disabled = !privateCheckbox.checked;
        if (privateCheckbox.checked) {
            recipientInput.focus();
        } else {
            recipientInput.value = "";
        }
    });

    // Join Room
    joinRoomBtn.addEventListener("click", () => {
        const selectedRoom = roomSelect.value;
        if (!selectedRoom) {
            alert("Please select a room");
            return;
        }

        if (currentRoom) {
            socket.emit("leaveRoom", currentRoom);
        }
        
        currentRoom = selectedRoom;
        socket.emit("joinRoom", currentRoom);
        
        // Update UI
        chatBox.innerHTML = `<div class="message system-message">
            <div class="message-bubble">You joined the ${currentRoom} room</div>
        </div>`;
        
        roomInfo.classList.add("active");
        currentRoomName.textContent = currentRoom;
        membersList.textContent = user.username;
        
        messageInput.disabled = false;
        sendBtn.disabled = false;
        privateMessageToggle.style.display = "flex";
        messageInput.focus();
    });

    // Send Message
    function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;

        // Check if it's a private message
        if (privateCheckbox.checked) {
            const recipient = recipientInput.value.trim();
            if (!recipient) {
                alert("Please enter a recipient username for private message");
                return;
            }

            if (recipient === user.username) {
                alert("You cannot send a private message to yourself");
                return;
            }

            const privateMsg = {
                from_user: user.username,
                to_user: recipient,
                message: message
            };
            
            socket.emit("privateMessage", privateMsg);
            
            // Display sent private message
            displayPrivateMessage(privateMsg, true);
            messageInput.value = "";
            recipientInput.value = "";
            privateCheckbox.checked = false;
            recipientInput.disabled = true;
        } else {
            // Send regular room message
            if (!currentRoom) {
                alert("Please join a room first");
                return;
            }

            const msg = {
                from_user: user.username,
                room: currentRoom,
                message: message
            };
            socket.emit("chatMessage", msg);
            messageInput.value = "";
        }
    }

    sendBtn.addEventListener("click", sendMessage);
    
    messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
            sendMessage();
        }
    });

    // Typing Indicator
    messageInput.addEventListener("input", () => {
        if (currentRoom && messageInput.value.trim() && !privateCheckbox.checked) {
            socket.emit("typing", { room: currentRoom, username: user.username });
        }
    });

    // Receive Room Messages
    socket.on("message", data => {
        displayRoomMessage(data);
    });

    // Receive Private Messages
    socket.on("privateMessage", data => {
        displayPrivateMessage(data, false);
    });

    // Handle message status (for offline users)
    socket.on("messageStatus", status => {
        if (!status.success) {
            alert(status.message);
        }
    });

    // Display Room Message
    function displayRoomMessage(data) {
        const isOwnMessage = data.from_user === user.username;
        const time = new Date().toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: true 
        });
        
        const messageHtml = `
            <div class="message ${isOwnMessage ? 'own-message' : ''}">
                <div class="message-header">
                    <span class="username">${data.from_user}</span>
                    <span class="timestamp">${time}</span>
                </div>
                <div class="message-bubble">${escapeHtml(data.message)}</div>
            </div>
        `;
        
        chatBox.insertAdjacentHTML('beforeend', messageHtml);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Display Private Message
    function displayPrivateMessage(data, isSent) {
        const time = new Date().toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: true 
        });
        
        const displayName = isSent ? `To ${data.to_user}` : `From ${data.from_user}`;
        const messageClass = isSent ? 'own-message' : '';
        
        const messageHtml = `
            <div class="message private-message ${messageClass}">
                <div class="message-header">
                    <span class="username">ðŸ”’ ${displayName} (Private)</span>
                    <span class="timestamp">${time}</span>
                </div>
                <div class="message-bubble private-bubble">${escapeHtml(data.message)}</div>
            </div>
        `;
        
        chatBox.insertAdjacentHTML('beforeend', messageHtml);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Typing Indicator
    socket.on("typing", username => {
        if (username !== user.username) {
            typingText.innerHTML = `<span class="typing-animation">${username} is typing</span>`;
            
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                typingText.textContent = "";
            }, 1000);
        }
    });

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", () => {
        if (confirm("Are you sure you want to logout?")) {
            localStorage.removeItem("user");
            window.location.href = "/views/login.html";
        }
    });

    // Helper function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Welcome message
    setTimeout(() => {
        if (!currentRoom) {
            chatBox.innerHTML = `
                <div class="empty-state">
                    <p>ðŸ‘‹ Welcome <strong>${user.firstname}</strong>! Select a room above to start chatting.</p>
                    <p style="font-size: 14px; color: #999; margin-top: 10px;">
                        ðŸ’¡ Tip: You can send private messages by checking the "Private Message" option below.
                    </p>
                </div>
            `;
        }
    }, 500);
</script>
</body>
</html>
